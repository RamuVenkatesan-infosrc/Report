service: report-analyzer-api

provider:
  name: aws
  runtime: python3.11
  region: us-east-1
  architecture: x86_64
  memorySize: 1000 
  timeout: 900
  deploymentMethod: direct

  apiGateway:
    binaryMediaTypes:
      - "*/*"

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"

        - Effect: Allow
          Action:
            - iam:GetRole
            - iam:PassRole
          Resource: "*"

        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
            - secretsmanager:DescribeSecret
          Resource:
            - arn:aws:secretsmanager:${aws:region}:${aws:accountId}:secret:*

        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:ListBucket
          Resource:
            - arn:aws:s3:::report-analyzer-*
            - arn:aws:s3:::report-analyzer-*/*

        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:BatchGetItem
            - dynamodb:BatchWriteItem
            - dynamodb:DescribeTable
          Resource:
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/*

        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: "*"

        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - arn:aws:lambda:${aws:region}:${aws:accountId}:function:report-analyzer-*

        - Effect: Allow
          Action:
            - bedrock:InvokeModel
            - bedrock:InvokeModelWithResponseStream
            - bedrock:ListModels
            - bedrock:GetModel
          Resource: "*"

custom:
  dotenv:
    include:
      - DATABASE_URL
      - GITHUB_TOKEN
      - OPENAI_API_KEY
      - SECRET_NAME
      - ALLOWED_ORIGINS

  pythonRequirements:
    layer: false
    usePipenv: false
    useStaticCache: false
    useDownloadCache: false
    dockerizePip: true

functions:
  report-analyzer-api:
    name: report-analyzer-api-${opt:stage, 'dev'}
    handler: reportanalysis_enhanced_v2.lambda_handler
    runtime: python3.11
    environment:
      SECRET_NAME: ${env:SECRET_NAME, 'report-analyzer-secrets'}
      DATABASE_URL: ${env:DATABASE_URL, ''}
      GITHUB_TOKEN: ${env:GITHUB_TOKEN, ''}
      OPENAI_API_KEY: ${env:OPENAI_API_KEY, ''}
      ALLOWED_ORIGINS: ${env:ALLOWED_ORIGINS, '*'}
      ENABLE_BEDROCK: ${env:ENABLE_BEDROCK, 'true'}
      BEDROCK_MODEL_ID: ${env:BEDROCK_MODEL_ID, 'anthropic.claude-3-5-sonnet-20240620-v1:0'}
      STAGE: ${opt:stage, 'dev'}
      LOG_LEVEL: INFO
    memorySize: 2048
    timeout: 900
    architecture: x86_64

    # âœ… Lambda Function URL (CORS simplified for Serverless v4+)
    url:
      cors: true

    package:
      include:
        - reportanalysis_enhanced_v2.py
        - app/**
      exclude:
        - venv/**
        - __pycache__/**
        - "*.pyc"
        - node_modules/**
        - .env
        - .git/**
        - tests/**

    events:
      - http:
          path: /
          method: any
          cors:
            origin: "*"
            allowCredentials: true
            headers:
              - Content-Type
              - Authorization
              - X-Requested-With

      - http:
          path: /{proxy+}
          method: any
          cors:
            origin: "*"
            allowCredentials: true
            headers:
              - Content-Type
              - Authorization
              - X-Requested-With

      - http:
          path: /openapi.json
          method: get
          cors:
            origin: "*"
            headers:
              - Content-Type
            allowCredentials: false

      - http:
          path: /docs
          method: get
          cors:
            origin: "*"
            headers:
              - Content-Type
            allowCredentials: false

      - http:
          path: /redoc
          method: get
          cors:
            origin: "*"
            headers:
              - Content-Type
            allowCredentials: false

package:
  patterns:
    - "!node_modules/**"
    - "!venv/**"
    - "!__pycache__/**"
    - "!.git/**"
    - "!.vscode/**"
    - "!tests/**"
    - "!*.pyc"
    - "!.env"
    - "!.env.*"
    - "reportanalysis_enhanced_v2.py"
    - "app/**"
  individually: false

plugins:
  - serverless-dotenv-plugin
  - serverless-python-requirements
