service: api-performance-analyzer
frameworkVersion: '4'

provider:
  name: aws
  runtime: python3.11
  region: us-east-1
  stage: dev
  memorySize: 1536
  timeout: 900
  architecture: x86_64

  environment:
    STAGE: dev
    BEDROCK_MODEL_ID: anthropic.claude-3-sonnet-20240229-v1:0
    MAX_TOKENS: 4000
    TEMPERATURE: 0.7
    ENABLE_BEDROCK: true
    GITHUB_TOKEN: ""
    DYNAMODB_ENDPOINT_URL: ""
    USE_LOCAL_DYNAMODB: false
    LOG_LEVEL: INFO

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"

        - Effect: Allow
          Action:
            - bedrock:InvokeModel
          Resource: "*"

        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - arn:aws:dynamodb:us-east-1:*:table/api-performance-analysis
            - arn:aws:dynamodb:us-east-1:*:table/github-analysis-results

functions:
  api:
    handler: main.handler
    name: api-performance-analyzer-${sls:stage}
    memorySize: 1536
    timeout: 900
    package:
      include:
        - main.py
        - report_analysis_v2.py
        - analyzers/**
        - services/**
        - utils/**
        - models/**
        - requirements.txt
      exclude:
        - venv/**
        - node_modules/**
        - __pycache__/**
        - tests/**
        - .git/**
        - .vscode/**
        - .env
        - .serverless/**
    events:
      - httpApi:
          path: /
          method: any
      - httpApi:
          path: /{proxy+}
          method: any

custom:
  pythonRequirements:
    dockerizePip: true
    layer: false
    slim: false
    zip: true
    invalidateCaches: true
    useStaticCache: false
    useDownloadCache: false

plugins:
  - serverless-python-requirements
